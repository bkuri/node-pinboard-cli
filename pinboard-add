#!/usr/bin/coffee
'use strict'

_ = (require 'lodash')
# chalk = (require 'chalk')
command = (require 'commander')
config = (require './config')
moment = (require 'moment')
Pinboard = (require 'node-pinboard')
pinboard = new Pinboard(config.token)


action = (url, desc) ->
  reply = (what) -> if what? and (what is yes) then 'yes' else 'no'

  try
    bookmark =
      url: url
      description: desc
      extended: command.extended
      tags: command.tags
      dt: command.date
      replace: (reply command.replaced)
      shared: (reply command.shared)
      toread: (reply command.toRead)

    pinboard.add bookmark, (res) ->
      process.exit not (res.result_code? and (res.result_code is 'done'))

  catch e
    console.error e
    process.exit yes

  return


command
  .usage '<url> <desc>'
  .option '-d, --date <date>', 'Date', moment.format()
  .option '-e, --extended [ext]', 'Extended description'
  .option '-R, --to-read', 'Tag to read later'
  .option '-r, --replace', 'Replace existing entry'
  .option '-s, --shared', 'Shared'
  .option '-t, --tags <tags>', 'filter by up to 3 tags (comma-separated)'
  .action action
  .parse process.argv

console.log "args: #{command.args}"
